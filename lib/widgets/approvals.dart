// ignore_for_file: prefer_const_constructors, prefer_const_literals_to_create_immutables, must_be_immutable

import 'dart:ui';

import 'package:flutter/material.dart';
import 'package:flutter_riverpod/flutter_riverpod.dart';
import 'package:flutter_screenutil/flutter_screenutil.dart';
import 'package:gymtracker/models/user_model.dart';
import 'package:gymtracker/notifiers/approval_notifier.dart';
import 'package:gymtracker/widgets/loader.dart';
import 'package:intl/intl.dart';

import '../constants.dart';
import '../providers/authentication_providers.dart';

class ApprovalsPage extends ConsumerStatefulWidget {
  List pendingApprovals;
  ApprovalsPage({Key? key, required this.pendingApprovals}) : super(key: key);

  @override
  ConsumerState<ApprovalsPage> createState() => _ApprovalsPageState();
}

class _ApprovalsPageState extends ConsumerState<ApprovalsPage> {
  // TextEditingController? _validityController;
  // TextEditingController? _moneyPaidController;
  late TextEditingController _dateController;
  @override
  void initState() {
    _dateController = TextEditingController();
    // _validityController = TextEditingController();
    // _moneyPaidController = TextEditingController();
    //getDetailsFromController();
    // final approvalState = ref.read(approvalControllerProvider);

    // approvalState.getApproveeUID(widget.pendingApprovals);
    // approvalState.getAllUsersDataFromFireStore();
    getDetailsFromController();
    // TODO: implement initState
    super.initState();
  }

  void getDetailsFromController() {
    ref.read(approvalControllerProvider)
      ..getConstraintDetails()
      ..getApproveeUID(widget.pendingApprovals)
      ..getAllUsersDataFromFireStore();
    //..get_isApprovalMembershipStartDateEditable();
  }

  @override
  void dispose() {
    // _validityController?.dispose();
    // _moneyPaidController?.dispose();
    // TODO: implement dispose
    super.dispose();
  }

  @override
  Widget build(BuildContext context) {
    final approvalState = ref.watch(approvalControllerProvider);
    //approvalState.getAllUsersDataFromFireStore();
    return GestureDetector(
      onTap: () {
        FocusScope.of(context).unfocus();
      },
      child: Scaffold(
        appBar: PreferredSize(
          child: ClipRRect(
            child: BackdropFilter(
              filter: ImageFilter.blur(sigmaX: 30, sigmaY: 30),
              child: AppBar(
                centerTitle: true,
                title: FittedBox(
                  fit: BoxFit.scaleDown,
                  child: Text(
                    'Pending Approval(s)',
                    style: TextStyle(
                      fontFamily: 'gilroy_bolditalic',
                      color: Color(0xffFED428),
                    ),
                    textAlign: TextAlign.center,
                  ),
                ),
                elevation: 0.0,
                backgroundColor: Colors.black.withOpacity(0.5),
              ),
            ),
          ),
          preferredSize: Size(
            double.infinity,
            56.0,
          ),
        ),
        backgroundColor: Color(0xff1A1F25),
        body: (approvalState.isDataLoading!)
            ? Center(
                child: Loader(
                  loadercolor: Color(0xffFED428),
                ),
              )
            : ListView.builder(
                itemCount: approvalState.usersModelData.length,
                itemBuilder: (context, index) {
                  return Consumer(builder: (context, ref, __) {
                    final approveButtonState =
                        ref.watch(testApprovalProvider(index));
                    final approveButtonNotifierState =
                        ref.watch(testApprovalProvider(index).notifier);
                    return Form(
                      key: approveButtonNotifierState.formKey,
                      child: Column(
                        children: [
                          Padding(
                            padding: EdgeInsets.symmetric(
                                vertical: 5.h, horizontal: 10.w),
                            child: Column(
                              children: [
                                Container(
                                  decoration: BoxDecoration(
                                    color: Color(0xff7e7d7d).withOpacity(0.09),
                                    borderRadius: BorderRadius.circular(10),
                                  ),
                                  child: Column(children: [
                                    dataApprovalBlock(
                                        tagData:
                                            (approvalState.usersModelData[index]
                                                    as UserModel)
                                                .userName,
                                        tagName: 'UserName'),
                                    dataApprovalBlock(
                                        tagData:
                                            (approvalState.usersModelData[index]
                                                    as UserModel)
                                                .phoneNumber
                                                .toString(),
                                        tagName: 'Phone'),
                                    dataApprovalBlock(
                                        tagData:
                                            (approvalState.usersModelData[index]
                                                    as UserModel)
                                                .enrolledGymDate,
                                        tagName: 'Submited On'),
                                    // approvalState.isDateEditable!
                                    //     ? birthYearSelectionWidget((approvalState
                                    //             .usersModelData[index] as UserModel)
                                    //         .enrolledGymDate!)
                                    //     : dataApprovalBlock(
                                    //         tagData:
                                    //             (approvalState.usersModelData[index]
                                    //                     as UserModel)
                                    //                 .enrolledGymDate,
                                    //         tagName: 'Submited On'),
                                    (approvalState.isPlanStartDateEnabled!)
                                        ? membershipStartDateWidget()
                                        : dataApprovalBlock(
                                            tagData: DateTime.now(),
                                            tagName: 'Approving On'),

                                    customTextField(
                                      controller: approveButtonNotifierState
                                          .validityController,
                                      isObscure: false,
                                      labeltext: 'validity (in months)',
                                      tia: TextInputAction.next,
                                    ),
                                    customTextField(
                                      controller: approveButtonNotifierState
                                          .moneyPaidController,
                                      isObscure: false,
                                      labeltext: 'Membership fees (â‚¹)',
                                      tia: TextInputAction.next,
                                    ),
                                    (approveButtonState.isDetailsUpdating ==
                                                false ||
                                            approveButtonState
                                                    .isRemovalUpdating ==
                                                false)
                                        ? Padding(
                                            padding: EdgeInsets.all(10.w),
                                            child: Row(
                                              mainAxisAlignment:
                                                  MainAxisAlignment.center,
                                              children: [
                                                Consumer(
                                                  builder:
                                                      (context, ref, child) {
                                                    return ElevatedButton(
                                                      style: ElevatedButton
                                                          .styleFrom(
                                                        //onPrimary: Colors.black,  //to change text color
                                                        padding: EdgeInsets
                                                            .symmetric(
                                                                vertical: 7.h,
                                                                horizontal:
                                                                    20.w),
                                                        primary: (approveButtonState
                                                                        .isRemoved ==
                                                                    true ||
                                                                approveButtonState
                                                                        .isApproved ==
                                                                    true)
                                                            ? Colors.grey
                                                            : color_gt_green, // button color
                                                        shape:
                                                            RoundedRectangleBorder(
                                                          borderRadius: BorderRadius
                                                              .circular(10
                                                                  .r), // <-- Radius
                                                        ),
                                                        textStyle: TextStyle(
                                                            color: Colors.black,
                                                            fontSize: 15.sp,
                                                            fontFamily:
                                                                'gilroy_bold'),
                                                      ),
                                                      onPressed: () {
                                                        if (approveButtonState
                                                                    .isRemoved ==
                                                                true ||
                                                            approveButtonState
                                                                    .isApproved ==
                                                                true) {
                                                          null;
                                                        } else {
                                                          final FormState form =
                                                              approveButtonNotifierState
                                                                  .formKey
                                                                  .currentState!;
                                                          if (form.validate()) {
                                                            approveButtonNotifierState
                                                                .approveUser(
                                                              approveeUID:
                                                                  approvalState
                                                                      .usersModelData[
                                                                          index]
                                                                      .uid,
                                                              index: index,
                                                              context: context,
                                                              userName:
                                                                  approvalState
                                                                      .usersModelData[
                                                                          index]
                                                                      .userName,
                                                              memberShipStartDate:
                                                                  (approvalState
                                                                          .isPlanStartDateEnabled!)
                                                                      ? approvalState
                                                                          .pickedDate
                                                                      : null,
                                                            );
                                                            print(
                                                                'form is valid');
                                                          } else {
                                                            print(
                                                                'Form is invalid');
                                                          }
                                                          //ref.watch(enrollControllerProvider).updateEnrollmentInfo();
                                                        }
                                                      },
                                                      child: (approveButtonState
                                                                  .isApproved ==
                                                              true)
                                                          ? Text('APPROVED')
                                                          : Text('APPROVE'),
                                                    );
                                                  },
                                                ),
                                                SizedBox(width: 30.w),
                                                Consumer(
                                                  builder:
                                                      (context, ref, child) {
                                                    return ElevatedButton(
                                                      style: ElevatedButton
                                                          .styleFrom(
                                                        //onPrimary: Colors.black,  //to change text color
                                                        padding: EdgeInsets
                                                            .symmetric(
                                                                vertical: 7.h,
                                                                horizontal:
                                                                    20.w),
                                                        primary: (approveButtonState
                                                                        .isRemoved ==
                                                                    true ||
                                                                approveButtonState
                                                                        .isApproved ==
                                                                    true)
                                                            ? Colors.grey
                                                            : Colors
                                                                .red, // button color
                                                        shape:
                                                            RoundedRectangleBorder(
                                                          borderRadius: BorderRadius
                                                              .circular(10
                                                                  .r), // <-- Radius
                                                        ),
                                                        textStyle: TextStyle(
                                                            color: Colors.black,
                                                            fontSize: 15.sp,
                                                            fontFamily:
                                                                'gilroy_bold'),
                                                      ),
                                                      onPressed: () {
                                                        if (approveButtonState
                                                                    .isRemoved ==
                                                                true ||
                                                            approveButtonState
                                                                    .isApproved ==
                                                                true) {
                                                          null;
                                                        } else {
                                                          showDialog(
                                                            context: context,
                                                            builder: (ctx) =>
                                                                RemoveButtonDialog(
                                                              index: index,
                                                              username: (approvalState
                                                                              .usersModelData[
                                                                          index]
                                                                      as UserModel)
                                                                  .userName,
                                                              uid: (approvalState
                                                                              .usersModelData[
                                                                          index]
                                                                      as UserModel)
                                                                  .uid!,
                                                            ),
                                                          );
                                                        }
                                                      },
                                                      child: (approveButtonState
                                                                  .isRemoved ==
                                                              true)
                                                          ? Text('REMOVED')
                                                          : Text('REMOVE'),
                                                    );
                                                  },
                                                ),
                                              ],
                                            ),
                                          )
                                        : Loader(
                                            loadercolor: Color(0xffFED428),
                                          ),
                                  ]),
                                ),
                                Padding(
                                  padding:
                                      EdgeInsets.only(top: 12.h, bottom: 6.h),
                                  child: Divider(
                                    color: color_gt_greenHalfOpacity
                                        .withOpacity(0.3),
                                    height: 1.h,
                                    thickness: 1,
                                    // endIndent: 10.w,
                                    // indent: 20.w,
                                  ),
                                ),
                              ],
                            ),
                          ),
                        ],
                      ),
                    );
                  });
                },
              ),
      ),
    );
  }

  membershipStartDateWidget() {
    return Padding(
      padding: EdgeInsets.only(bottom: 5.h, top: 10.h, left: 10.w, right: 10.w),
      child: Theme(
        data: Theme.of(context).copyWith(
          colorScheme: ThemeData().colorScheme.copyWith(
                primary: Color(0xffFED428),
              ),
        ),
        child: Consumer(builder: (context, ref, child) {
          final approvalState = ref.watch(approvalControllerProvider);
          return Row(
            mainAxisAlignment: MainAxisAlignment.spaceBetween,
            children: [
              Text(
                'Start Date : ',
                style: TextStyle(
                  fontSize: 14.sp,
                  color: Color(0xffFED428),
                  fontFamily: 'gilroy_bold',
                ),
              ),
              SizedBox(
                width: MediaQuery.of(context).size.width * 0.65,
                child: TextFormField(
                  validator: (value) {
                    return (value!.isEmpty)
                        ? 'Plan start date cannot be empty'
                        : null;
                  },
                  enableInteractiveSelection: false,
                  showCursor: false,
                  keyboardType: TextInputType.none,
                  cursorHeight: 18.sp,
                  cursorRadius: Radius.circular(30.r),
                  style: TextStyle(
                      fontSize: 15.sp,
                      fontFamily: 'gilroy_regular',
                      color: Colors.white70),
                  decoration: InputDecoration(
                    filled: true,
                    fillColor: Color(0xff20242A),
                    floatingLabelStyle: TextStyle(
                      fontFamily: "gilroy_bolditalic",
                      fontSize: 16.sp,
                      color: color_gt_headersTextColorWhite.withOpacity(0.9),
                    ),
                    labelText: 'Membership start date',
                    labelStyle: TextStyle(
                      fontSize: 16.sp,
                      color: color_gt_headersTextColorWhite.withOpacity(0.75),
                    ),
                    errorBorder: OutlineInputBorder(
                      borderRadius: BorderRadius.circular(10.r),
                      borderSide:
                          const BorderSide(color: Colors.red, width: 0.25),
                    ),
                    focusedErrorBorder: OutlineInputBorder(
                      borderRadius: BorderRadius.circular(10.r),
                      borderSide: BorderSide(
                          color: Color(0xff7e7d7d).withOpacity(0.05)),
                    ),
                    errorStyle: TextStyle(
                        fontFamily: 'gilroy_regularitalic',
                        color: Colors.red[500]!,
                        fontSize: 12.sp),
                    enabledBorder: OutlineInputBorder(
                      borderRadius: BorderRadius.circular(10.r),
                      borderSide: BorderSide(
                          color: Color(0xff7e7d7d).withOpacity(0.05)),
                    ),
                    focusedBorder: OutlineInputBorder(
                      borderRadius: BorderRadius.circular(10.r),
                      borderSide: BorderSide(
                          color: Color(0xff7e7d7d).withOpacity(0.05)),
                    ),
                  ),
                  controller: _dateController,
                  cursorColor: color_gt_textColorBlueGrey,
                  onTap: () async {
                    DateTime? pickedDate = await showDatePicker(
                      context: context,
                      initialDatePickerMode: DatePickerMode.year,
                      initialEntryMode: DatePickerEntryMode.calendarOnly,
                      initialDate: DateTime.now(),
                      firstDate: DateTime(
                          1900), //DateTime.now() - not to allow to choose before today.
                      lastDate: DateTime(2101),
                    );
                    if (pickedDate != null) {
                      print(pickedDate);
                      String dateForDisplay =
                          convertDateToDisplayFormat(pickedDate);
                      String dateForDb =
                          DateFormat('dd-MM-yyyy').format(pickedDate);
                      approvalState.updateDate(pickedDate);

                      _dateController.text = dateForDb;
                    }
                  },
                ),
              ),
            ],
          );
        }),
      ),
    );
  }

  String convertDateToDisplayFormat(DateTime dt) {
    // convert datetime obj to display compatible date format
    return DateFormat('dd-MM-yyyy').format(dt);
  }

  customTextField({
    required TextEditingController controller,
    required TextInputAction tia,
    required String labeltext,
    required bool isObscure,
  }) {
    return Padding(
      padding: EdgeInsets.only(
        bottom: 10.sp,
        left: 10.w,
        right: 10.w,
        top: 10.sp,
      ),
      child: Theme(
        data: Theme.of(context).copyWith(
          colorScheme: ThemeData().colorScheme.copyWith(
                primary: color_gt_green,
              ),
        ),
        child: Consumer(builder: (context, ref, child) {
          return TextFormField(
            validator: (value) {
              if (labeltext == 'validity (in months)') {
                if (controller.text.isEmpty) {
                  return 'membership validity data can\'t be empty !';
                } else if (int.parse(controller.text) > 12) {
                  return 'kindly enter equal or less than 12 months !';
                }
                return null;
              }
              if (labeltext == 'Membership fees (â‚¹)') {
                if (controller.text.isEmpty) {
                  return 'enter the money paid for the membership !';
                } else if (int.parse(controller.text) > 50000) {
                  return 'Can\'t exceed â‚¹50,000 !';
                }
                return null;
              }
            },
            cursorHeight: 18.sp,
            cursorRadius: Radius.circular(30.r),
            style: TextStyle(
                fontSize: 15.sp,
                fontFamily: 'gilroy_regular',
                color: Colors.white70),
            keyboardType: TextInputType.phone,
            textInputAction: tia,
            decoration: InputDecoration(
              filled: true,
              fillColor: Color(0xff20242A),
              floatingLabelStyle: TextStyle(
                fontFamily: "gilroy_bolditalic",
                fontSize: 16.sp,
                color: color_gt_headersTextColorWhite.withOpacity(0.9),
              ),
              labelText: labeltext,
              labelStyle: TextStyle(
                fontSize: 16.sp,
                color: color_gt_headersTextColorWhite.withOpacity(0.75),
              ),
              errorBorder: OutlineInputBorder(
                borderRadius: BorderRadius.circular(10.r),
                borderSide: const BorderSide(color: Colors.red, width: 0.25),
              ),
              focusedErrorBorder: OutlineInputBorder(
                borderRadius: BorderRadius.circular(10.r),
                borderSide:
                    BorderSide(color: Color(0xff7e7d7d).withOpacity(0.05)),
              ),
              errorStyle: TextStyle(
                  fontFamily: 'gilroy_regularitalic',
                  color: Colors.red[500]!,
                  fontSize: 12.sp),
              enabledBorder: OutlineInputBorder(
                borderRadius: BorderRadius.circular(10.r),
                borderSide:
                    BorderSide(color: Color(0xff7e7d7d).withOpacity(0.05)),
              ),
              focusedBorder: OutlineInputBorder(
                borderRadius: BorderRadius.circular(10.r),
                borderSide:
                    BorderSide(color: Color(0xff7e7d7d).withOpacity(0.05)),
              ),
            ),
            controller: controller,
            cursorColor: color_gt_textColorBlueGrey,
          );
        }),
      ),
    );
  }

  dataApprovalBlock({required String tagName, required var tagData}) {
    return Padding(
      padding: const EdgeInsets.all(10.0),
      child: Row(
        mainAxisAlignment: MainAxisAlignment.spaceBetween,
        children: [
          Text(
            '$tagName : ',
            style: TextStyle(
              fontSize: 14.sp,
              color: Color(0xffFED428),
              fontFamily: 'gilroy_bold',
            ),
          ),
          Container(
            height: 43.h,
            width: MediaQuery.of(context).size.width * 0.65,
            decoration: BoxDecoration(
              color: Color(0xff20242A),
              borderRadius: BorderRadius.circular(10.r),
              border: Border.all(
                  width: 1, color: Color(0xff7e7d7d).withOpacity(0.05)),
            ),
            child: Padding(
              padding: EdgeInsets.symmetric(horizontal: 10.w, vertical: 14.h),
              child: Text(
                (tagData.runtimeType == DateTime)
                    ? DateFormat('dd-MMM-yyyy').format(tagData)
                    : tagData,
                style: TextStyle(
                  fontSize: 14.sp,
                  color: color_gt_headersTextColorWhite,
                  fontFamily: 'gilroy_regular',
                ),
              ),
            ),
          ),
        ],
      ),
    );
  }
}

class RemoveButtonDialog extends ConsumerStatefulWidget {
  int index;
  String username;
  String uid;
  RemoveButtonDialog({
    Key? key,
    required this.index,
    required this.username,
    required this.uid,
  }) : super(key: key);

  @override
  ConsumerState<RemoveButtonDialog> createState() => _RemoveButtonDialogState();
}

class _RemoveButtonDialogState extends ConsumerState<RemoveButtonDialog> {
  @override
  Widget build(BuildContext context) {
    final approveButtonNotifierState =
        ref.watch(testApprovalProvider(widget.index).notifier);
    return AnimatedContainer(
      duration: Duration(
        milliseconds: 500,
      ),
      curve: Curves.fastLinearToSlowEaseIn,
      child: AlertDialog(
        shape: RoundedRectangleBorder(
            borderRadius: BorderRadius.all(Radius.circular(20.r))),
        backgroundColor: Color(0xff1A1F25),
        title: Text(
          "Remove Approval Request",
          textAlign: TextAlign.center,
          style: TextStyle(
            fontFamily: 'gilroy_bold',
            color: Color(0xffFED428),
          ),
        ),
        content: RichText(
          textAlign: TextAlign.center,
          text: TextSpan(
            children: [
              TextSpan(
                text: 'Are you sure want to remove ',
                style: TextStyle(
                  fontFamily: 'gilroy_regular',
                  color: Color(0xff7E7D7D),
                ),
              ),
              TextSpan(
                text: "\"${widget.username}\"",
                style:
                    TextStyle(fontFamily: 'gilroy_bold', color: Colors.white),
              ),
              TextSpan(
                text: ' approval request ?',
                style: TextStyle(
                    fontFamily: 'gilroy_regular', color: Color(0xff7E7D7D)),
              ),
            ],
          ),
        ),
        actions: <Widget>[
          // ignore: deprecated_member_use
          Padding(
            padding: EdgeInsets.only(bottom: 5.h),
            // ignore: deprecated_member_use
            child: FlatButton(
              onPressed: () {
                Navigator.of(context).pop();
              },
              child: Text(
                "NO",
                style: TextStyle(
                    fontFamily: 'gilroy_regular',
                    fontWeight: FontWeight.bold,
                    color: Colors.white),
              ),
            ),
          ),
          Padding(
            padding: EdgeInsets.only(right: 8.w, bottom: 5.h),
            // ignore: deprecated_member_use
            child: FlatButton(
              minWidth: 50,
              shape: const RoundedRectangleBorder(
                  borderRadius: BorderRadius.all(Radius.circular(10.0))),
              color: Colors.red,
              onPressed: () async {
                await approveButtonNotifierState.removeUser(
                  approveeUID: widget.uid,
                  context: context,
                );
                Navigator.of(context).pop();
              },
              child: Text(
                "REMOVE",
                style: TextStyle(
                    fontFamily: 'gilroy_regular',
                    fontWeight: FontWeight.bold,
                    color: Colors.white),
              ),
            ),
          ),
        ],
      ),
    );
  }
}
